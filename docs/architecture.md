# Архитектура платформы

## Обзор

Онлайн-платформа состоит из микросервисов, связанных через шину событий и API шлюз. Основная цель архитектуры — обеспечить модульность, гибкость и возможность масштабирования при подключении новых игровых провайдеров и платёжных систем. Решение разделено на клиентскую часть (Next.js) и набор сервисов на NestJS, общающихся по REST/GraphQL и событиям Kafka/NATS.

## Общая схема

```text
┌────────────────┐         ┌────────────────┐
│    Frontend    │  HTTPS  │  API Gateway   │
│  Next.js App   │◄───────►│  (NestJS BFF)  │
└────────────────┘         └─────┬──────────┘
                                  │REST/GraphQL
             ┌────────────────────┼─────────────────────┐
             │                    │                     │
   ┌────────────────┐   ┌──────────────────┐   ┌────────────────┐
   │ User Service   │   │ Wallet Service   │   │  Game Service   │
   └────────────────┘   └──────────────────┘   └────────────────┘
             │                    │                     │
             │                    │                     │
             ▼                    ▼                     ▼
        PostgreSQL          PostgreSQL/Redis        Provider APIs
             │                    │                     │
             └───────┬────────────┴────────────┬────────┘
                     │                         │
                     ▼                         ▼
                ClickHouse                Payment Gateway
                     ▲                         │
                     └─────────────┬───────────┘
                                   ▼
                                Kafka/NATS
```

### Основные технологии

| Слой                | Технологии                                                                 |
|---------------------|------------------------------------------------------------------------------|
| Клиент              | Next.js (React + TypeScript), Tailwind CSS, shadcn/ui, React Query, WebSocket |
| API Gateway/BFF     | NestJS, GraphQL (Apollo) + REST, OpenAPI, Redis (кэш), JWT                   |
| Бэкенд сервисы      | NestJS (микросервисы), TypeORM, BullMQ/NestJS CQRS                           |
| Сообщения/Очереди   | Kafka или NATS                                                               |
| БД транзакций       | PostgreSQL (основные данные)                                                |
| БД аналитики        | ClickHouse (ETL через Airflow/Temporal Workers)                             |
| Мониторинг          | OpenTelemetry, Prometheus, Grafana, Loki                                     |
| Инфраструктура      | Docker, Kubernetes, Helm, GitHub Actions, ArgoCD                             |

## Модули бэкенда

### User Module
- Регистрация и аутентификация пользователей через Telegram OAuth, email и 2FA.
- Управление профилем, KYC статусами и настройками Responsible Gaming.
- Поддержка уведомлений через NotificationService.

### Wallet Module
- Управление балансовыми счетами: основной, бонусный, заблокированный.
- Создание и исполнение транзакций (депозиты, выводы, ставки, начисления).
- Гарантированная целостность транзакций с помощью саги и идемпотентных ключей.

### Game Module
- Каталог игр, фильтрация по провайдеру, жанру, волатильности.
- Создание SSO-сессий и проксирование запросов к провайдерам.
- Обработка callback-уведомлений с результатами ставок.

### Payment Module
- Интеграция с платёжным шлюзом (Stripe/PayPal) через REST/GraphQL адаптеры.
- Обработка вебхуков, смена статусов (pending, success, failed).
- Проверки лимитов и KYC перед выводом.

### Report Module
- Генерация пользовательских отчётов на ClickHouse по агрегированным данным.
- Планировщик ETL для доставки данных из PostgreSQL в ClickHouse.
- Экспорт в CSV/Excel/JSON, сохранение шаблонов отчётов.

### Admin Module
- Панель мониторинга, управление пользователями, провайдерами и платежами.
- Просмотр логов, антифрод-алерты, управление лимитами и бонусами.

## API Gateway / BFF

API Gateway предоставляет REST и GraphQL эндпоинты для фронтенда и изолирует детали микросервисов. Он реализует:
- Аутентификацию (JWT, обновление refresh-токенов, проверка ролей).
- Агрегацию данных из нескольких сервисов для отображения на одной странице.
- Rate limiting, кэширование, трассировку запросов.

## Интеграция с Telegram и 2FA

1. Пользователь проходит Telegram Login Widget и отправляет email.
2. Отправляется код подтверждения на email, создаётся сессия в Redis.
3. После подтверждения email пользователь выбирает метод 2FA (TOTP/SMS).
4. Создаётся учётная запись в PostgreSQL с привязкой Telegram ID, email и статусом KYC.

## Платёжные потоки

- **Депозит**: запрос создаёт платёжный intent → редирект на шлюз → вебхук подтверждает статус → Wallet Module фиксирует транзакцию и обновляет баланс.
- **Вывод**: пользователь создаёт заявку → система проверяет лимиты/KYC → отправляет в платёжную систему → вебхук подтверждает → средства списываются и фиксируются в отчётах.

## Работа с игровыми провайдерами

Каждый провайдер имеет адаптер, реализующий общий интерфейс (`launchGame`, `processBet`, `fetchBalance`). Провайдеры регистрируются в модуле GameService и могут динамически добавляться через конфигурацию.

Callback-эндпоинты принимают уведомления о ставках и выигрыше, валидируют подпись и создают финансовые транзакции в Wallet Module.

## Аналитика и отчётность

- События транзакций и игровых действий публикуются в Kafka/NATS.
- Worker сервисы читают события и выполняют ETL в ClickHouse.
- Конструктор отчётов строит запросы к ClickHouse через аналитический API, генерируя таблицы и графики.

## Мониторинг и логирование

- OpenTelemetry агенты отправляют метрики и трассы в OTLP Collector.
- Prometheus собирает метрики, Grafana визуализирует состояние.
- Loki/ELK хранят логи аудита и бизнес-событий.

## Контейнеризация и CI/CD

- Dockerfile для каждого сервиса, Docker Compose для локальной разработки.
- Kubernetes манифесты/Helm чарты для продакшена.
- GitHub Actions выполняет линт, тесты, сборку образов и деплой через ArgoCD.

## План разработки

1. **Этап 1 (1–2 месяца)**: регистрация, личный кабинет, базовые платежи и одна игра.
2. **Этап 2 (2–3 месяца)**: конструктор отчётов, интеграция ClickHouse, админка.
3. **Этап 3 (4–6 месяцев)**: масштабирование, мониторинг, антифрод.

